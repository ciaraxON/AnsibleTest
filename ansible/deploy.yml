---
- name: Deploy files from GitHub repo to server
  hosts: virtuabox
  become: true

  vars:
    src_repo: "{{ playbook_dir }}/../filestodeploy"
    dest_dir: "/opt/app/destination"
    backup_dir: "/opt/app/backups"

  tasks:
    - name: Ensure destination directory exists
      ansible.builtin.file:
        path: "{{ dest_dir }}"
        state: directory
        mode: "0755"

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0755"

    - name: Find files in source repository (on control machine)
      delegate_to: localhost
      become: false
      ansible.builtin.find:
        paths: "{{ src_repo }}"
        file_type: file
      register: found_files

    - name: Fail if no files were found
      ansible.builtin.fail:
        msg: "No files found in {{ src_repo }}"
      when: found_files.matched == 0

    - name: Check whether destination files exist (for backup)
      ansible.builtin.stat:
        path: "{{ dest_dir }}/{{ item.path | basename }}"
      register: dest_stats
      loop: "{{ found_files.files }}"

    - name: Backup existing files if they exist
      ansible.builtin.copy:
        src: "{{ dest_dir }}/{{ item.item.path | basename }}"
        dest: "{{ backup_dir }}/{{ item.item.path | basename }}.{{ ansible_date_time.iso8601 }}"
        remote_src: true
      loop: "{{ dest_stats.results }}"
      when: item.stat.exists

    - name: Copy new files to destination (control â†’ remote)
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ dest_dir }}/{{ item.path | basename }}"
        mode: "0644"
      loop: "{{ found_files.files }}"

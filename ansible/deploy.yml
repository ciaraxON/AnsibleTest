---
- name: Deploy files from GitHub repo to server
  hosts: virtuabox     # or change to "target" if your inventory group is named target
  become: true

  vars:
    src_repo: "{{ playbook_dir }}/../filestodeploy"
    dest_dir: "/opt/app/destination"
    backup_dir: "/opt/app/backups"

  tasks:
    - name: Ensure destination directory exists
      ansible.builtin.file:
        path: "{{ dest_dir }}"
        state: directory
        mode: "0755"

    - name: Ensure backup directory exists
      ansible.builtin.file:
        path: "{{ backup_dir }}"
        state: directory
        mode: "0755"

    - name: Find files in source repository (on control machine)
      delegate_to: localhost
      become: false
      ansible.builtin.find:
        paths: "{{ src_repo }}"
        file_type: file
      register: found_files

    - name: Backup existing files if they exist
      ansible.builtin.copy:
        src: "{{ dest_dir }}/{{ item.path | basename }}"
        dest: "{{ backup_dir }}/{{ item.path | basename }}.{{ ansible_date_time.iso8601 }}"
        remote_src: true
      loop: "{{ found_files.files }}"
      ignore_errors: true

    - name: Copy new files to destination (control -> remote)
      ansible.builtin.copy:
        src: "{{ item.path }}"
        dest: "{{ dest_dir }}/{{ item.path | basename }}"
        mode: "0644"
      loop: "{{ found_files.files }}"
